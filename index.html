<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Smart Tourist Safety System</title>

<style>
body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f5f5f5;
}

h1 { color: #c0392b; }

#map {
    width: 90%;
    height: 450px;
    margin: 20px auto;
    border: 2px solid #ccc;
}

#sosBtn {
    background: #e74c3c;
    color: white;
    padding: 15px 35px;
    font-size: 18px;
    border: none;
    border-radius: 30px;
    cursor: pointer;
}

#status {
    margin-top: 15px;
    font-weight: bold;
    white-space: pre-line;
    color: green;
}
</style>
</head>

<body>

<h1>ðŸš¨ Smart Tourist Safety System</h1>
<button id="sosBtn">Send SOS</button>
<div id="status"></div>
<div id="map"></div>

<script>
let map;
let holdTimer;

const ICONS = {
    user: "https://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
    hospital: "https://maps.google.com/mapfiles/ms/icons/green-dot.png",
    police: "https://maps.google.com/mapfiles/ms/icons/red-dot.png"
};

// Initialize map
function initMap() {
    map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15
    });
    getLiveLocation();
}

// Get accurate live location
function getLiveLocation() {
    if (!navigator.geolocation) {
        alert("Geolocation not supported");
        return;
    }

    navigator.geolocation.getCurrentPosition(
        position => {
            const userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            map.setCenter(userLocation);

            // User marker (YELLOW)
            new google.maps.Marker({
                position: userLocation,
                map: map,
                icon: ICONS.user,
                title: "Your Location"
            });

            // Find nearby services
            searchPlaces(userLocation, "hospital");
            searchPlaces(userLocation, "police station");
        },
        () => alert("Please allow GPS location"),
        {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        }
    );
}

// Search hospitals & police
function searchPlaces(location, keyword) {
    const service = new google.maps.places.PlacesService(map);

    service.nearbySearch(
        {
            location: location,
            radius: 5000,
            keyword: keyword
        },
        (results, status) => {
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                results.forEach(place => {
                    new google.maps.Marker({
                        position: place.geometry.location,
                        map: map,
                        icon: keyword === "hospital"
                            ? ICONS.hospital
                            : ICONS.police,
                        title: place.name
                    });
                });
            }
        }
    );
}

// Press & hold SOS
const sosBtn = document.getElementById("sosBtn");

sosBtn.addEventListener("mousedown", () => {
    holdTimer = setTimeout(sendSOS, 3000);
});
sosBtn.addEventListener("mouseup", () => clearTimeout(holdTimer));
sosBtn.addEventListener("mouseleave", () => clearTimeout(holdTimer));

// Send SOS with correct GPS
function sendSOS() {
    document.getElementById("status").innerText = "Getting accurate GPS location...";

    navigator.geolocation.getCurrentPosition(
        position => {
            const lat = position.coords.latitude.toFixed(6);
            const lng = position.coords.longitude.toFixed(6);

            fetch(`http://127.0.0.1:5000/send-sos?lat=${lat}&lng=${lng}`)
                .then(res => res.json())
                .then(data => {
                    if (data.status === "success") {
                        document.getElementById("status").innerText =
                            "âœ” Location detected\n" +
                            "âœ” Hospitals marked\n" +
                            "âœ” Police stations marked\n" +
                            "âœ” SOS with location link sent via WhatsApp";
                    } else {
                        document.getElementById("status").innerText = "SOS failed";
                    }
                })
                .catch(() => {
                    document.getElementById("status").innerText = "Backend not reachable";
                });
        },
        () => alert("Unable to get GPS location"),
        {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 0
        }
    );
}
</script>

<script
src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCI2dMCZEYoVgNzmorC1GNle3ZY3e3ZSvc&libraries=places&callback=initMap"
async defer>
</script>

</body>
</html>
